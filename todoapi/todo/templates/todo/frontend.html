<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìù Todo Frontend</title>
  <style>
    body { font-family: Arial; margin: 30px; }
    .task { margin-bottom: 10px; }
    .auth-box, .todo-box { margin-top: 20px; }
    label { display: block; margin-top: 10px; }
    input { margin-bottom: 10px; }
  </style>
</head>
<body>

  <h1>‚úÖ Todo App</h1>

  <div class="auth-box">
    <h2>üîê Login or Register</h2>
    <form id="authForm">
      <label>Username: <input type="text" id="username" required></label>
      <label>Password: <input type="password" id="password" required></label>
      <button type="submit">Login</button>
      <button type="button" onclick="register()">Register</button>
    </form>
    <div id="authMessage"></div>
  </div>

  <div class="todo-box" style="display: none;">
    <h2>üìã Your Tasks</h2>
    <div id="todoList">Loading tasks...</div>

    <h3>Add New Task</h3>
    <form id="todoForm">
      <label>Title: <input type="text" id="taskTitle" required></label>
      <label>Description: <input type="text" id="taskDescription"></label>
      <label>Status:
        <select id="taskStatus">
          <option value="PENDING">Pending</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="COMPLETED">Completed</option>
        </select>
      </label>
      <label>Due Date: <input type="date" id="taskDueDate"></label>
      <button type="submit">Add Task</button>
    </form>
    <div id="todoMessage"></div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api/todo/todo";
    let token = "JEHnobPkiLls4QoIRFTx9W1sBsJBFI";

    document.getElementById("authForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const res = await fetch(`${API_BASE}/login/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      if (res.ok) {
        token = data.token;
        document.querySelector(".auth-box").style.display = "none";
        document.querySelector(".todo-box").style.display = "block";
        loadTodos();
      } else {
        document.getElementById("authMessage").innerText = data.error || "Login failed.";
      }
    });

    async function register() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const res = await fetch(`${API_BASE}/register/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      if (res.ok) {
        document.getElementById("authMessage").innerText = "üéâ Registered! You can now login.";
      } else {
        document.getElementById("authMessage").innerText = data.error || "Registration failed.";
      }
    }

    async function loadTodos() {
      const res = await fetch(`${API_BASE}/todo/`, {
        headers: { "Authorization": `Token ${token}` }
      });
      const data = await res.json();
      const list = document.getElementById("todoList");
      list.innerHTML = "";
      data.forEach(task => {
        list.innerHTML += `<div class="task">üìù <strong>${task.title}</strong> - ${task.status}</div>`;
      });
    }

    document.getElementById("todoForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const task = {
        title: document.getElementById("taskTitle").value,
        description: document.getElementById("taskDescription").value,
        status: document.getElementById("taskStatus").value,
        due_date: document.getElementById("taskDueDate").value
      };

      const res = await fetch(`${API_BASE}/todo/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Token ${token}`
        },
        body: JSON.stringify(task)
      });

      const data = await res.json();
      if (res.ok) {
        document.getElementById("todoMessage").innerText = "‚úÖ Task added!";
        document.getElementById("todoForm").reset();
        loadTodos();
      } else {
        document.getElementById("todoMessage").innerText = "‚ùå Failed to add task.";
        console.error(data);
      }
    });
  </script>

</body>
</html>
